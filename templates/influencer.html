<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Influencer Safety - TrustEngine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="flex h-screen overflow-hidden">
        
        <div class="w-80 bg-white border-r border-slate-200 flex flex-col z-20">
            <div class="p-6 border-b border-slate-100 flex items-center gap-2">
                <i class="fa-solid fa-shield-halved text-indigo-600 text-xl"></i>
                <span class="font-bold text-slate-800 tracking-tight">TrustEngine</span>
            </div>
            <button onclick="window.location.href='/dashboard.html'" class="m-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Back to Dashboard</button>
            
            
            <div class="p-4">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                    <input type="text" id="search-input" placeholder="Find creator..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition">
                </div>
            </div>

            <div id="creator-list" class="flex-1 overflow-y-auto">
                <div class="p-4 text-center text-slate-400 text-sm">Loading creators...</div>
            </div>
        </div>

        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <div class="flex-1 overflow-y-auto p-8" id="main-view" style="display: none;">
                
                <div class="flex justify-between items-start mb-8">
                    <div class="flex items-center gap-5">
                        <div class="w-20 h-20 rounded-full bg-slate-200 p-0.5 border-2 border-indigo-100 relative">
                            <img id="profile-image" src="" class="w-full h-full rounded-full object-cover">
                        </div>
                        <div>
                            <h1 id="profile-name" class="text-3xl font-bold text-slate-900 mb-1"></h1>
                            <div class="flex items-center gap-3 text-sm mb-2">
                                <span id="profile-handle" class="text-slate-500 font-medium"></span>
                                <span class="text-slate-300">â€¢</span>
                                <span id="profile-followers" class="text-slate-600"></span> Followers
                            </div>
                            <div class="flex gap-2">
                                <span class="px-2.5 py-0.5 rounded-full bg-slate-100 text-slate-600 text-xs font-semibold border border-slate-200">Travel & Lifestyle</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="generateDeal()" class="px-4 py-2 bg-white border border-slate-200 text-slate-700 font-medium rounded-lg text-sm hover:bg-slate-50 transition shadow-sm flex items-center gap-2">
                            <i class="fa-solid fa-file-contract text-slate-400"></i> Deal Architect
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-12 gap-6 mb-8">
                    
                    <div class="col-span-4 bg-white rounded-2xl p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
                        <h3 class="font-semibold text-slate-800 mb-4">Content Composition</h3>
                        <div class="flex-1 flex flex-col items-center justify-center py-4">
                            <span id="ai-percent-big" class="text-6xl font-bold text-slate-900 tracking-tight">0%</span>
                            <span class="text-sm text-slate-500 font-medium mt-1">AI Usage Detected</span>
                        </div>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                            <div id="ai-progress-bar" class="h-full bg-indigo-600 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="col-span-4 bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                        <h3 class="font-semibold text-slate-800 mb-6 flex justify-between">
                            Risk Analysis
                            <i id="risk-spinner" class="fa-solid fa-circle-notch fa-spin text-slate-300 hidden"></i>
                        </h3>
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3 text-slate-600">
                                    <i class="fa-solid fa-triangle-exclamation text-slate-400 w-4"></i> Toxicity
                                </div>
                                <span id="risk-toxicity" class="px-2.5 py-0.5 bg-slate-100 text-slate-500 text-xs font-bold rounded-md">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3 text-slate-600">
                                    <i class="fa-solid fa-users text-slate-400 w-4"></i> Fake Followers
                                </div>
                                <span id="risk-fake" class="text-red-600 font-bold text-sm">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3 text-slate-600">
                                    <i class="fa-solid fa-bullhorn text-slate-400 w-4"></i> Misleading Claims
                                </div>
                                <span id="risk-claims" class="px-2.5 py-0.5 bg-slate-100 text-slate-500 text-xs font-bold rounded-md">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-4 bg-[#2d2a84] rounded-2xl p-6 shadow-lg text-white relative overflow-hidden flex flex-col justify-between">
                        <div class="absolute top-0 right-0 p-6 opacity-10">
                            <i class="fa-solid fa-brain text-8xl"></i>
                        </div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-4 opacity-80 text-xs font-bold uppercase tracking-wider">
                                <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                                Campaign Agent
                            </div>
                            
                            <div class="mb-4 p-3 bg-white/10 backdrop-blur-sm rounded-lg border border-white/10">
                                <div id="camp-safe-title" class="flex items-center gap-2 mb-1 text-slate-300 font-bold text-sm">
                                    <i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing...
                                </div>
                                <p id="camp-safe-desc" class="text-xs text-indigo-100 leading-relaxed opacity-90 font-medium">
                                    Running safety checks...
                                </p>
                            </div>

                            <div class="p-3 bg-white/10 backdrop-blur-sm rounded-lg border border-white/10">
                                <div class="flex items-center gap-2 mb-1 text-blue-300 font-bold text-sm">
                                    <i class="fa-solid fa-thumbs-up"></i> Brand Fit
                                </div>
                                <p id="camp-brand-desc" class="text-xs text-indigo-100 leading-relaxed opacity-80">
                                    Evaluating brand alignment...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-regular fa-images"></i> Recent Content Scan
                    </h3>
                    <div class="grid grid-cols-5 gap-4" id="content-grid">
                        <div class="aspect-square rounded-xl bg-slate-100 overflow-hidden relative group cursor-pointer border border-slate-200 shadow-sm" id="post-card-1">
                            <img id="post-img-1" src="" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center p-4">
                                <p id="post-cap-1" class="text-white text-xs text-center line-clamp-3"></p>
                            </div>
                            <div id="ai-badge-1" class="absolute top-2 right-2 px-2 py-0.5 bg-black/50 backdrop-blur text-white text-[10px] rounded font-medium">Scanning</div>
                            <div id="ai-reason-1" class="absolute bottom-2 left-2 right-2 bg-red-600/90 text-white text-[10px] p-2 rounded opacity-0 transition-opacity"></div>
                        </div>
                        <div class="aspect-square rounded-xl bg-slate-100 overflow-hidden relative group cursor-pointer border border-slate-200 shadow-sm" id="post-card-2">
                            <img id="post-img-2" src="" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center p-4">
                                <p id="post-cap-2" class="text-white text-xs text-center line-clamp-3"></p>
                            </div>
                            <div id="ai-badge-2" class="absolute top-2 right-2 px-2 py-0.5 bg-black/50 backdrop-blur text-white text-[10px] rounded font-medium">Scanning</div>
                            <div id="ai-reason-2" class="absolute bottom-2 left-2 right-2 bg-red-600/90 text-white text-[10px] p-2 rounded opacity-0 transition-opacity"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="deal-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-6 backdrop-blur-sm">
                <div class="bg-white rounded-2xl max-w-2xl w-full p-8 shadow-2xl animate-fade-in-up">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-800">Deal Architect</h2>
                        <button onclick="document.getElementById('deal-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <p class="text-sm text-slate-500 mb-1">Estimated Market Value</p>
                            <p id="modal-market" class="text-2xl font-bold text-slate-800">--</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500 mb-1">Suggested Offer</p>
                            <p id="modal-offer" class="text-2xl font-bold text-indigo-600">--</p>
                        </div>
                        <div class="col-span-2 bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <p class="text-xs font-bold text-slate-400 uppercase mb-2">Agent Reasoning</p>
                            <p id="modal-reasoning" class="text-sm text-slate-600 leading-relaxed">--</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let influencersData = [];
        let currentInfluencer = null;

        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/influencers')
                .then(response => response.json())
                .then(data => {
                    influencersData = data;
                    renderSidebar(data);
                    if (data.length > 0) loadInfluencer(data[0]);
                });
        });

        function renderSidebar(data) {
            const container = document.getElementById('creator-list');
            container.innerHTML = '';
            data.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = `creator-item flex items-center gap-3 p-4 hover:bg-slate-50 cursor-pointer border-l-4 transition-all ${index === 0 ? 'border-indigo-600 bg-indigo-50/50' : 'border-transparent'}`;
                item.onclick = () => {
                    document.querySelectorAll('.creator-item').forEach(el => {
                        el.classList.remove('border-indigo-600', 'bg-indigo-50/50');
                        el.classList.add('border-transparent');
                    });
                    item.classList.remove('border-transparent');
                    item.classList.add('border-indigo-600', 'bg-indigo-50/50');
                    loadInfluencer(user);
                };
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-slate-200 overflow-hidden flex-shrink-0">
                         <img src="${user.user_profile}" class="w-full h-full object-cover">
                    </div>
                    <div class="overflow-hidden">
                        <h4 class="text-sm font-bold text-slate-800 truncate">${user.user_name.replace('_', ' ')}</h4>
                        <p class="text-xs text-slate-500 truncate">@${user.user_name}</p>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function loadInfluencer(user) {
            currentInfluencer = user;
            document.getElementById('main-view').style.display = 'block';
            
            // 1. Basic Info
            document.getElementById('profile-name').textContent = user.user_name.replace('_', ' ');
            document.getElementById('profile-handle').textContent = '@' + user.user_name;
            document.getElementById('profile-followers').textContent = user.user_followers.toLocaleString();
            document.getElementById('profile-image').src = user.user_profile;

            // 2. AI % Calculation (Placeholder logic)
            let aiCount = 0;
            if(user.user_post_1?.ai_generated) aiCount++;
            if(user.user_post_2?.ai_generated) aiCount++;
            const percent = (aiCount / 2) * 100;
            document.getElementById('ai-percent-big').textContent = `${percent}%`;
            document.getElementById('ai-progress-bar').style.width = `${percent}%`;
            const colorClass = percent > 50 ? 'text-red-600' : 'text-slate-900';
            document.getElementById('ai-percent-big').className = `text-6xl font-bold tracking-tight ${colorClass}`;

            // 3. Post Grid Logic
            setupPostCard(1, user.user_post_1);
            setupPostCard(2, user.user_post_2);

            // 4. Trigger Profile Risk & Campaign Agent
            generateProfileRisk(user);
        }

        function setupPostCard(id, post) {
            const imgEl = document.getElementById(`post-img-${id}`);
            const capEl = document.getElementById(`post-cap-${id}`);
            const badgeEl = document.getElementById(`ai-badge-${id}`);
            const reasonEl = document.getElementById(`ai-reason-${id}`);

            if(post) {
                imgEl.src = post.image_path;
                capEl.textContent = post.caption;
                badgeEl.textContent = "Auditing...";
                badgeEl.className = "absolute top-2 right-2 px-2 py-0.5 bg-black/50 backdrop-blur text-white text-[10px] rounded font-medium animate-pulse";
                reasonEl.style.opacity = "0";

                fetch('/api/analyze-post-live', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ image_path: post.image_path, caption: post.caption })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.is_ai_generated) {
                        badgeEl.innerHTML = "<i class='fa-solid fa-robot'></i> SYNTHETIC";
                        badgeEl.className = "absolute top-2 right-2 px-2 py-0.5 bg-red-600 text-white text-[10px] rounded font-bold shadow-md border border-white/20";
                        // Show strict reason
                        reasonEl.textContent = data.detection_reason;
                        reasonEl.style.opacity = "1";
                    } else {
                        badgeEl.innerHTML = "<i class='fa-solid fa-check'></i> VERIFIED";
                        badgeEl.className = "absolute top-2 right-2 px-2 py-0.5 bg-green-500 text-white text-[10px] rounded font-bold shadow-sm";
                    }
                });
            }
        }

        function generateProfileRisk(user) {
            // Show Spinner
            document.getElementById('risk-spinner').classList.remove('hidden');
            
            fetch('/api/analyze-profile-risk', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(user)
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('risk-spinner').classList.add('hidden');
                
                // Update Risk Card
                const r = data.risk_analysis;
                updateRiskBadge('risk-toxicity', r.toxicity);
                document.getElementById('risk-fake').textContent = r.fake_followers;
                updateRiskBadge('risk-claims', r.misleading_claims);

                // Update Campaign Agent Card
                const c = data.campaign_agent;
                const safeTitle = document.getElementById('camp-safe-title');
                
                if(c.safe_to_collaborate) {
                    safeTitle.innerHTML = `<i class="fa-solid fa-check-circle"></i> Safe to Collaborate`;
                    safeTitle.className = "flex items-center gap-2 mb-1 text-green-300 font-bold text-sm";
                } else {
                    // Harsh mode styling
                    safeTitle.innerHTML = `<i class="fa-solid fa-ban"></i> DANGEROUS / DO NOT HIRE`;
                    safeTitle.className = "flex items-center gap-2 mb-1 text-red-400 font-extrabold text-sm uppercase";
                }
                document.getElementById('camp-safe-desc').textContent = c.collaboration_logic;
                document.getElementById('camp-brand-desc').textContent = c.brand_fit_logic;
            });
        }

        function updateRiskBadge(id, level) {
            const el = document.getElementById(id);
            el.textContent = level;
            if(level === 'Low') el.className = "px-2.5 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-md";
            else if(level === 'Medium') el.className = "px-2.5 py-0.5 bg-yellow-100 text-yellow-700 text-xs font-bold rounded-md";
            else el.className = "px-2.5 py-0.5 bg-red-100 text-red-700 text-xs font-bold rounded-md border border-red-200";
        }

        function generateDeal() {
            if(!currentInfluencer) return;
            document.getElementById('deal-modal').classList.remove('hidden');
            document.getElementById('modal-market').textContent = "Calculating...";
            document.getElementById('modal-offer').textContent = "...";
            document.getElementById('modal-reasoning').textContent = "AI Agent is structuring the deal...";

            fetch('/api/generate-deal', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(currentInfluencer)
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('modal-market').textContent = data.market_rate;
                document.getElementById('modal-offer').textContent = data.suggested_offer;
                document.getElementById('modal-reasoning').textContent = data.agent_reasoning;
            });
        }

        // Search Filter
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = influencersData.filter(u => u.user_name.toLowerCase().includes(term));
            renderSidebar(filtered);
        });
    </script>
</body>
</html>